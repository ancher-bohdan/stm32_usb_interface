#define ARM_MATH_CM4

#include "dsp.h"

#include "stm32f4xx.h"
#include "arm_math.h"

#include <stdint.h>

/*

FIR filter designed with
https://fiiir.com

sampling frequency: 48000 Hz
window type: Kaiser

* Cutoff frequency fL = 1440 Hz
  Transition bandwidth bL = 2400 Hz

* Cutoff frequency fH = 6720 Hz
  Transition bandwidth bH = 2400 Hz

* Stopband attenuation A = 48 dB

*/

#define CALC_REQUEST_BUFFER_SIZE  10

struct
{
    int16_t *pSamples;
    void (*dsp_finish_cbk)(void * arg);
    void *arg;
}dsp_request[CALC_REQUEST_BUFFER_SIZE];
uint8_t read = 0, write = 0;

#define SAMPLES_SIZE   192
#define FILTER_TAP_NUM  113
static float32_t filter_taps[FILTER_TAP_NUM] = {
    -0.000000237826318603,    -0.000001048382832110,    -0.000002290942952586,
    -0.000003292128299338,    -0.000003226749535401,    -0.000001852031963691,
    -0.000000000000000013,    0.000000775821153757,    -0.000000591938552114,
    -0.000003442711737357,    -0.000005273012141259,    -0.000003272603931862,
    0.000003301855389624,    0.000011761341891918,    0.000017173127704737,
    0.000015890606657660,    0.000009112262907565,    0.000003428602587549,
    0.000006942684485541,    0.000022802046669120,    0.000044633949181488,
    0.000058198559245719,    0.000050081482596451,    0.000019380645439984,
    -0.000014617108724494,    -0.000014457976189989,    0.000063289683786471,
    0.000251215693577667,    0.000188101980986161,    -0.000093166809870236,
    0.000321493653397029,    0.001926749565142658,    0.004235310106271513,
    0.005721839721660659,    0.004849146263554378,    0.001581325442044208,
    -0.001954280810401556,    -0.002660289281191723,    0.000924771007667064,
    0.006568594786762028,    0.008959253503958115,    0.003350077369681444,
    -0.010050070986278197,    -0.024607706929591612,    -0.030917925456199605,
    -0.023984643535233725,    -0.008868181593046391,    0.000380926022777862,
    -0.010432912008625710,    -0.043919383122310196,    -0.084820047928213932,
    -0.105254101942637318,    -0.080317018482966157,    -0.005216337118936548,
    0.097358575772134831,    0.185844314724997600,    0.220722402268747897,
    0.185844314724999293,    0.097358575772134928,    -0.005216337118936841,
    -0.080317018482966129,    -0.105254101942637429,    -0.084820047928213738,
    -0.043919383122310002,    -0.010432912008625637,    0.000380926022778079,
    -0.008868181593046386,    -0.023984643535233732,    -0.030917925456199612,
    -0.024607706929591678,    -0.010050070986278191,    0.003350077369681432,
    0.008959253503958143,    0.006568594786762056,    0.000924771007667048,
    -0.002660289281191704,    -0.001954280810401561,    0.001581325442044182,
    0.004849146263554373,    0.005721839721660651,    0.004235310106271530,
    0.001926749565142666,    0.000321493653397026,    -0.000093166809870225,
    0.000188101980986160,    0.000251215693577659,    0.000063289683786469,
    -0.000014457976189972,    -0.000014617108724471,    0.000019380645439999,
    0.000050081482596456,    0.000058198559245723,    0.000044633949181489,
    0.000022802046669112,    0.000006942684485543,    0.000003428602587560,
    0.000009112262907573,    0.000015890606657658,    0.000017173127704732,
    0.000011761341891916,    0.000003301855389616,    -0.000003272603931875,
    -0.000005273012141258,    -0.000003442711737335,    -0.000000591938552099,
    0.000000775821153748,    -0.000000000000000012,    -0.000001852031963691,
    -0.000003226749535403,    -0.000003292128299350,    -0.000002290942952590,
    -0.000001048382832100,    -0.000000237826318596};

static arm_fir_instance_f32 fir;

float fir_states[FILTER_TAP_NUM + (2 * SAMPLES_SIZE) - 1];
float tmp[2][SAMPLES_SIZE];
float32_t scale = 4;

void dsp_init(void)
{
  arm_fir_init_f32(&fir, FILTER_TAP_NUM, filter_taps, fir_states, SAMPLES_SIZE);
}

int dsp_calculation_request(int16_t *p_samples, void (*dsp_cbk)(void * arg), void *args)
{
    if((read == write) && (dsp_request[write].pSamples != NULL))
    {
        return DSP_EBUSY;
    }

    dsp_request[write].pSamples = p_samples;
    dsp_request[write].dsp_finish_cbk = dsp_cbk;
    dsp_request[write].arg = args;

    write = (write + 1) % CALC_REQUEST_BUFFER_SIZE;

    return DSP_EOK;
}

void dsp_process()
{
    if((read == write) && (dsp_request[read].pSamples == NULL))
    {
        return;
    }

    arm_q15_to_float(dsp_request[read].pSamples, &(tmp[0][0]), SAMPLES_SIZE);

    arm_fir_f32(&fir, &(tmp[0][0]), &(tmp[1][0]), SAMPLES_SIZE);
    arm_scale_f32(&(tmp[1][0]), scale, &(tmp[0][0]), SAMPLES_SIZE);

    arm_float_to_q15(&(tmp[0][0]), dsp_request[read].pSamples, SAMPLES_SIZE);

    dsp_request[read].dsp_finish_cbk(dsp_request[read].arg);
    
    dsp_request[read].pSamples = NULL;
    read = (read + 1) % CALC_REQUEST_BUFFER_SIZE;

}

void dsp_mute(uint8_t cmd)
{
  scale = cmd == 1 ? 0 : 4;
}

