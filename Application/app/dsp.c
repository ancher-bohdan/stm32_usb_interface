#define ARM_MATH_CM4

#include "dsp.h"

#include "stm32f4xx.h"
#include "arm_math.h"

#include <stdint.h>

/*

FIR filter designed with
https://fiiir.com

sampling frequency: 48000 Hz
*/

#define CALC_REQUEST_BUFFER_SIZE  10

struct
{
    int16_t *pSamples;
    void (*dsp_finish_cbk)(void * arg);
    void *arg;
}dsp_request[CALC_REQUEST_BUFFER_SIZE];
uint8_t read = 0, write = 0;

#define SAMPLES_SIZE   192
#define FILTER_TAP_NUM  124
static float32_t filter_taps[FILTER_TAP_NUM] = {
    0.000000168314749357,    0.000000247185904286,    0.000000143199536074,    0.000000552671830941,
    0.000000308467917663,    0.000000691454636736,    0.000000883336034459,    0.000000561310920877,
    0.000001533034567932,    0.000000642621122314,    0.000001319263465414,    0.000001363976078621,
    0.000000000000000014,    0.000001707947183759,    -0.000001089431857774,    -0.000000289512862545,
    -0.000000918151301592,    -0.000004547158444518,    -0.000001459572297379,    -0.000007724840082807,
    -0.000006194234660058,    -0.000007344832971369,    -0.000014430331807572,    -0.000006893922686791,
    -0.000019140196482101,    -0.000013610217477167,    -0.000013743297065918,    -0.000029161820837419,
    -0.000001149604213102,    -0.000044569822830765,    0.000007129329937061,    0.000783389374470130,
    0.000514753411890985,    0.000100574290103565,    0.002049486563196424,    -0.000052053064596724,
    0.002623452179897545,    0.002052450240347048,    0.000974098361195189,    0.005787439278138969,
    -0.000417020820269856,    0.005899894359955151,    0.003142717277254117,    -0.001045141033312298,
    0.008998011894623851,    -0.007821034940885492,    0.004752329725374108,    -0.003680627082964057,
    -0.014798386897916131,    0.005057165934797589,    -0.031895055416207622,    -0.006145414998226252,
    -0.023633595785933111,    -0.045799643847181271,    -0.001510042141670668,    -0.077448079463504044,
    -0.015306341124640882,    -0.048365585431546884,    -0.097270024514173686,    0.043244387182882468,
    -0.207682300546546850,    0.127220434152759854,    0.739649555433358197,    0.127220434152760187,
    -0.207682300546546073,    0.043244387182882010,    -0.097270024514173631,    -0.048365585431547162,
    -0.015306341124640861,    -0.077448079463503544,    -0.001510042141670504,    -0.045799643847181340,
    -0.023633595785933069,    -0.006145414998226182,    -0.031895055416207629,    0.005057165934797615,
    -0.014798386897916099,    -0.003680627082964058,    0.004752329725374089,    -0.007821034940885525,
    0.008998011894623821,    -0.001045141033312280,    0.003142717277254070,    0.005899894359955193,
    -0.000417020820269854,    0.005787439278138941,    0.000974098361195233,    0.002052450240347058,
    0.002623452179897561,    -0.000052053064596729,    0.002049486563196350,    0.000100574290103566,
    0.000514753411890997,    0.000783389374470135,    0.000007129329937111,    -0.000044569822830767,
    -0.000001149604213138,    -0.000029161820837417,    -0.000013743297065933,    -0.000013610217477173,
    -0.000019140196482099,    -0.000006893922686800,    -0.000014430331807570,    -0.000007344832971372,
    -0.000006194234660069,    -0.000007724840082810,    -0.000001459572297399,    -0.000004547158444518,
    -0.000000918151301589,    -0.000000289512862549,    -0.000001089431857739,    0.000001707947183766,
    0.000000000000000014,    0.000001363976078620,    0.000001319263465384,    0.000000642621122316,
    0.000001533034567933,    0.000000561310920885,    0.000000883336034489,    0.000000691454636743,
    0.000000308467917664,    0.000000552671830944,    0.000000143199536061,    0.000000247185904281
};

static arm_fir_instance_f32 fir;

float fir_states[FILTER_TAP_NUM + (2 * SAMPLES_SIZE) - 1];
float tmp[2][SAMPLES_SIZE];
float32_t scale = 4;

void dsp_init(void)
{
  arm_fir_init_f32(&fir, FILTER_TAP_NUM, filter_taps, fir_states, SAMPLES_SIZE);
}

int dsp_calculation_request(int16_t *p_samples, void (*dsp_cbk)(void * arg), void *args)
{
    if((read == write) && (dsp_request[write].pSamples != NULL))
    {
        return DSP_EBUSY;
    }

    dsp_request[write].pSamples = p_samples;
    dsp_request[write].dsp_finish_cbk = dsp_cbk;
    dsp_request[write].arg = args;

    write = (write + 1) % CALC_REQUEST_BUFFER_SIZE;

    return DSP_EOK;
}

void dsp_process()
{
    if((read == write) && (dsp_request[read].pSamples == NULL))
    {
        return;
    }

    arm_q15_to_float(dsp_request[read].pSamples, &(tmp[0][0]), SAMPLES_SIZE);

    arm_fir_f32(&fir, &(tmp[0][0]), &(tmp[1][0]), SAMPLES_SIZE);
    arm_scale_f32(&(tmp[1][0]), scale, &(tmp[0][0]), SAMPLES_SIZE);

    arm_float_to_q15(&(tmp[0][0]), dsp_request[read].pSamples, SAMPLES_SIZE);

    dsp_request[read].dsp_finish_cbk(dsp_request[read].arg);
    
    dsp_request[read].pSamples = NULL;
    read = (read + 1) % CALC_REQUEST_BUFFER_SIZE;

}

void dsp_mute(uint8_t cmd)
{
  scale = cmd == 1 ? 0 : 4;
}

