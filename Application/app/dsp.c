#define ARM_MATH_CM4

#include "dsp.h"

#include "stm32f4xx.h"
#include "arm_math.h"

#include <stdint.h>

/*

FIR filter designed with
http://t-filter.engineerjs.com/

sampling frequency: 16000 Hz

* 0 Hz - 200 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -36.176292098921564 dB

* 300 Hz - 4000 Hz
  gain = 5
  desired ripple = 5 dB
  actual ripple = 6.673345917347996 dB

* 4100 Hz - 8000 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -36.176292098921564 dB

*/

#define CALC_REQUEST_BUFFER_SIZE  10

struct
{
    int16_t *pSamples;
    void (*dsp_finish_cbk)(void * arg);
    void *arg;
}dsp_request[CALC_REQUEST_BUFFER_SIZE];
uint8_t read = 0, write = 0;

#define SAMPLES_SIZE   64
#define FILTER_TAP_NUM 168

static float32_t filter_taps[FILTER_TAP_NUM] = {
  0.002628447671262255,  -0.0559372716847574,  -0.1386054196741942,  -0.11255537840344187,
  0.10444013941089103,  0.3463702594373756,  0.34163925106230675,  0.08262196954210936,
  -0.1278912575648488,  -0.08862263458840716,  0.032919458975990634,  -0.0037056068338420234,
  -0.13514745379437007,  -0.14209526540666037,  -0.035278217203356166,  -0.012309736151262194,
  -0.09717294963261726,  -0.11722422993644066,  -0.03115704044546433,  0.006881373825646707,
  -0.05562103254809826,  -0.08039888015133263,  -0.009480900339576994,  0.030488825029742123,
  -0.021657489953527558,  -0.04830213952438241,  0.013027578933010632,  0.051213964340637796,
  0.003368431567505858,  -0.02398637398236738,  0.03180054581661283,  0.06713293747861855,
  0.019861454525567625,  -0.007929481300092097,  0.045322667623616544,  0.07789281175541067,
  0.028788806207336218,  0.00038530607820524233,  0.053152070433784435,  0.0831560930472034,
  0.03038062529723888,  0.001127861635814318,  0.05506599241761837,  0.08271424819717603,
  0.024603675936453205,  -0.005860133440942732,  0.05066127986794021,  0.07598403716578062,
  0.010804747783224506,  -0.021034584600963666,  0.03987459954166424,  0.06310615918511005,
  -0.010935254966807152,  -0.04408256135745083,  0.023687912939728568,  0.04522219317471397,
  -0.04008547915251627,  -0.07452429425022679,  0.003491422447701939,  0.024058408836860713,
  -0.07567565065034382,  -0.11135244104174115,  -0.018233402400683846,  0.002337128551107418,
  -0.11671229043884472,  -0.15347312997956586,  -0.03740268086372553,  -0.015246081023756207,
  -0.16208918111508544,  -0.19998312058219858,  -0.04731498383505398,  -0.021975418959344517,
  -0.21541428282974243,  -0.25631014693894,  -0.0369674528612531,  -0.002526703290144642,
  -0.289063301837193,  -0.3420570764593192,  0.03145535163554085,  0.09945140250078097,
  -0.47424680283976267,  -0.6302770864955436,  0.5686949624543496,  2.094129488019814,
  2.094129488019814,  0.5686949624543496,  -0.6302770864955436,  -0.47424680283976267,
  0.09945140250078097,  0.03145535163554085,  -0.3420570764593192,  -0.289063301837193,
  -0.002526703290144642,  -0.0369674528612531,  -0.25631014693894,  -0.21541428282974243,
  -0.021975418959344517,  -0.04731498383505398,  -0.19998312058219858,  -0.16208918111508544,
  -0.015246081023756207,  -0.03740268086372553,  -0.15347312997956586,  -0.11671229043884472,
  0.002337128551107418,  -0.018233402400683846,  -0.11135244104174115,  -0.07567565065034382,
  0.024058408836860713,  0.003491422447701939,  -0.07452429425022679,  -0.04008547915251627,
  0.04522219317471397,  0.023687912939728568,  -0.04408256135745083,  -0.010935254966807152,
  0.06310615918511005,  0.03987459954166424,  -0.021034584600963666,  0.010804747783224506,
  0.07598403716578062,  0.05066127986794021,  -0.005860133440942732,  0.024603675936453205,
  0.08271424819717603,  0.05506599241761837,  0.001127861635814318,  0.03038062529723888,
  0.0831560930472034,  0.053152070433784435,  0.00038530607820524233,  0.028788806207336218,
  0.07789281175541067,  0.045322667623616544,  -0.007929481300092097,  0.019861454525567625,
  0.06713293747861855,  0.03180054581661283,  -0.02398637398236738,  0.003368431567505858,
  0.051213964340637796,  0.013027578933010632,  -0.04830213952438241,  -0.021657489953527558,
  0.030488825029742123,  -0.009480900339576994,  -0.08039888015133263,  -0.05562103254809826,
  0.006881373825646707,  -0.03115704044546433,  -0.11722422993644066,  -0.09717294963261726,
  -0.012309736151262194,  -0.035278217203356166,  -0.14209526540666037,  -0.13514745379437007,
  -0.0037056068338420234,  0.032919458975990634,  -0.08862263458840716,  -0.1278912575648488,
  0.08262196954210936,  0.34163925106230675,  0.3463702594373756,  0.10444013941089103,
  -0.11255537840344187,  -0.1386054196741942,  -0.0559372716847574,  0.002628447671262255
};

static arm_fir_instance_f32 fir;

float fir_states[FILTER_TAP_NUM + (2 * SAMPLES_SIZE) - 1];
float tmp[2][SAMPLES_SIZE];

void dsp_init(void)
{
  arm_fir_init_f32(&fir, FILTER_TAP_NUM, filter_taps, fir_states, SAMPLES_SIZE);
}

int dsp_calculation_request(int16_t *p_samples, void (*dsp_cbk)(void * arg), void *args)
{
    if((read == write) && (dsp_request[write].pSamples != NULL))
    {
        return DSP_EBUSY;
    }

    dsp_request[write].pSamples = p_samples;
    dsp_request[write].dsp_finish_cbk = dsp_cbk;
    dsp_request[write].arg = args;

    write = (write + 1) % CALC_REQUEST_BUFFER_SIZE;

    return DSP_EOK;
}

void dsp_process()
{
    if((read == write) && (dsp_request[read].pSamples == NULL))
    {
        return;
    }

    arm_q15_to_float(dsp_request[read].pSamples, &(tmp[0][0]), SAMPLES_SIZE);

    arm_fir_f32(&fir, &(tmp[0][0]), &(tmp[1][0]), SAMPLES_SIZE);

    arm_float_to_q15(&(tmp[1][0]), dsp_request[read].pSamples, SAMPLES_SIZE);

    dsp_request[read].dsp_finish_cbk(dsp_request[read].arg);
    
    dsp_request[read].pSamples = NULL;
    read = (read + 1) % CALC_REQUEST_BUFFER_SIZE;

}

